---
title: "comparison_deforestation"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{comparison_deforestation}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup, echo=FALSE}

library(activelearning)
library(dplyr)
library(caret)
library(ggplot2)
library(sits)

sits_method <- sits::sits_xgboost(verbose = FALSE)

# Get samples of deforestation.
samples_tb <- system.file("extdata/samples.rds",
                          package = "activelearning") %>%
  readRDS() %>% 
  dplyr::group_by(label) %>%
  dplyr::sample_frac(size = 0.1) %>% 
  dplyr::ungroup() %>% 
  magrittr::set_class(class(sits::cerrado_2classes))
 
# Initial number of labels to be taken from each label.
n_labelled   <- 3

# Number of labels to be selected on each iteration.
n_samples    <- length(unique(samples_tb$label)) * 3

# Number of consecutive iterations.
n_iterations <- 30 

# Number of times the experiment is repeated.
n_experiments <- 30 

source("comparison_deforestation_util.R")

```



## Test Active Learning using only known samples.

```{r run_experiments, echo=FALSE}

acc_no_al <- lapply(seq_len(n_experiments), 
                    FUN = function(x, samples_tb, sits_method, n_iterations,
                                   n_samples) {
         experiment(start_samples_tb = start_sample_set(samples_tb = samples_tb, 
                                                        n_samples = n_samples), 
                    sits_method = sits_method, 
                    n_iterations = n_iterations,
                    n_samples = n_samples,
                    f_new_samples = new_samples_no_al) %>% 
                        dplyr::mutate(type = "No Active Learning") %>% 
                        return()
                    },
         samples_tb = samples_tb,
         sits_method = sits_method,
         n_iterations = n_iterations,
         n_samples = n_samples)

acc_egal  <- lapply(seq_len(n_experiments), 
                    FUN = function(x, samples_tb, sits_method, n_iterations,
                                   n_samples) {
         experiment(start_samples_tb = start_sample_set(samples_tb = samples_tb, 
                                                        n_samples = n_samples), 
                    sits_method = sits_method, 
                    n_iterations = n_iterations,
                    n_samples = n_samples,
                    f_new_samples = new_samples_egal) %>% 
                        dplyr::mutate(type = "EGAL") %>% 
                        return()
                    },
         samples_tb = samples_tb,
         sits_method = sits_method,
         n_iterations = n_iterations,
         n_samples = n_samples)

acc_rs    <- lapply(seq_len(n_experiments), 
                    FUN = function(x, samples_tb, sits_method, n_iterations,
                                   n_samples) {
         experiment(start_samples_tb = start_sample_set(samples_tb = samples_tb, 
                                                        n_samples = n_samples), 
                    sits_method = sits_method, 
                    n_iterations = n_iterations,
                    n_samples = n_samples,
                    f_new_samples = new_samples_rs) %>% 
                        dplyr::mutate(type = "AL random sampling") %>% 
                        return()
                    },
         samples_tb = samples_tb,
         sits_method = sits_method,
         n_iterations = n_iterations,
         n_samples = n_samples)

acc_no_al <- acc_no_al %>% 
  dplyr::bind_rows()
acc_egal <- acc_egal %>%
  dplyr::bind_rows()
acc_rs <- acc_rs %>%
  dplyr::bind_rows()

# TODO: Add test for s2.


```



```{r plot, echo=FALSE, fig.width=11.693, fig.height=8.268}

dplyr::bind_rows(acc_no_al, acc_egal, acc_rs) %>%
  dplyr::filter(metric == "f1") %>%
  ggplot2::ggplot() + 
  ggplot2::geom_boxplot(ggplot2::aes(x = n_samples,
                                     y = accuracy,
                                     group = n_training)) +
  ggplot2::facet_grid(cols = dplyr::vars(class),
                      rows = dplyr::vars(type)) +
  ggplot2::labs(title = "Active learning accuracy",
                subtitle = paste("Amazonia samples",
                                 paste(n_experiments, " runs"),
                                 paste(n_iterations, " iterations"),
                                 sep = " - ")) +
  ggplot2::xlab("Number of training samples") + 
  ggplot2::ylab("F1 score")

```

